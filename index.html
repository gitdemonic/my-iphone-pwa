<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å° do è¡Œæç¢ºèª v1.5.0</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --ios-bg: #F2F2F7; --ios-card: #FFFFFF; --ios-blue: #007AFF; --ios-sep: #C6C6C8; --ios-red: #FF3B30; --ios-yellow: #FFCC00; --ios-green: #34C759; }
        body { background-color: var(--ios-bg); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 120px; overflow-x: hidden; }
        
        .sticky-top {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid var(--ios-sep); padding-bottom: 12px;
        }
        .header { padding: 50px 20px 0; position: relative; }
        .settings-btn { position: absolute; top: 55px; right: 20px; color: var(--ios-blue); font-size: 17px; cursor: pointer; }
        .header h1 { margin: 0; font-size: 34px; letter-spacing: -0.5px; }
        .header-btns { display: flex; gap: 15px; margin-top: 12px; padding: 0 20px; overflow-x: auto; }
        .btn-text { color: var(--ios-blue); font-size: 16px; cursor: pointer; white-space: nowrap; font-weight: 500; }

        .sync-status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #8e8e93; font-weight: 600; margin-bottom: 6px; padding: 0 20px; }
        .led { width: 9px; height: 9px; border-radius: 50%; }
        .led-syncing { background: var(--ios-yellow); box-shadow: 0 0 5px var(--ios-yellow); }
        .led-done { background: var(--ios-green); }
        .led-error { background: var(--ios-red); }

        /* é¡åˆ¥å®¹å™¨æ¨£å¼ (ç”¨æ–¼ä¸»é …ç›®æ’åº) */
        .category-wrapper { margin-bottom: 10px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 25px 20px 10px; background: transparent; }
        .section-left { display: flex; align-items: center; gap: 10px; }
        .section-title { font-size: 13px; color: #6e6e73; text-transform: uppercase; font-weight: 600; }

        /* ä¸»é …ç›®æ‹–æ‹½æ‰‹æŠŠ (â ¿) */
        .cat-drag-handle { color: #8E8E93; font-size: 18px; display: none; cursor: grab; }
        .is-editing .cat-drag-handle { display: inline-block; }

        .list-group { background: var(--ios-card); border-top: 0.5px solid var(--ios-sep); border-bottom: 0.5px solid var(--ios-sep); }
        .list-item { display: flex; align-items: center; padding: 14px 20px; border-bottom: 0.5px solid var(--ios-sep); background: white; }
        .item-content { flex: 1; }
        .item-name { font-size: 17px; color: #000; }
        .item-note { font-size: 14px; color: #8e8e93; }

        .edit-mode-only { display: none !important; }
        .is-editing .edit-mode-only { display: flex !important; }
        .is-editing .checkbox { display: none !important; }
        
        .checkbox { width: 24px; height: 24px; border-radius: 50%; border: 1.5px solid var(--ios-sep); margin-right: 15px; flex-shrink: 0; }
        .checkbox.checked { background-color: var(--ios-blue); border-color: var(--ios-blue); }
        .checkbox.checked::after { content: 'âœ“'; color: white; display: block; text-align: center; line-height: 22px; font-weight: bold; }
        
        .drag-handle { color: #C7C7CC; font-size: 22px; padding-left: 10px; display: none; cursor: grab; }
        .is-editing .drag-handle { display: flex; }

        /* å½ˆçª— */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 5000; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .modal.show { display: flex; opacity: 1; pointer-events: auto; }
        .modal-content { background: white; padding: 28px; border-radius: 20px; width: 85%; max-width: 380px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }

        input, select { width: 100%; padding: 14px 16px; margin: 10px 0; border: 1px solid var(--ios-sep); border-radius: 12px; font-size: 17px; }
        .btn-primary { background: var(--ios-blue); color: white; border: none; padding: 16px; border-radius: 12px; width: 100%; font-weight: 600; font-size: 17px; margin-top: 10px; }
        .btn-secondary { background: #E5E5EA; color: #000; border: none; padding: 16px; border-radius: 12px; width: 100%; font-weight: 500; font-size: 17px; }

        #sync-sheet { width: 100%; padding: 10px 15px 30px; box-sizing: border-box; transform: translateY(100%); transition: transform 0.3s ease-out; }
        .modal.show #sync-sheet { transform: translateY(0); }
        .sheet-container { background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-radius: 14px; overflow: hidden; margin-bottom: 10px; }
        .sheet-btn { padding: 18px; text-align: center; border-bottom: 0.5px solid var(--ios-sep); font-size: 18px; color: var(--ios-blue); cursor: pointer; }
        .sheet-cancel { background: white; border-radius: 14px; padding: 18px; text-align: center; font-size: 18px; font-weight: 600; color: var(--ios-blue); cursor: pointer; }

        .quick-nav { position: fixed; right: 8px; top: 55%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 14px; background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); padding: 14px 8px; border-radius: 24px; border: 0.5px solid var(--ios-sep); z-index: 999; }
        .nav-item { font-size: 11px; color: var(--ios-blue); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body id="body">

    <div class="sticky-top">
        <div class="header">
            <span class="settings-btn" onclick="toggleSettings()">âš™ï¸ è¨­å®š</span>
            <div class="sync-status">
                <span id="sync-led" class="led led-done"></span>
                <span id="sync-text">v1.5.0 å°±ç·’</span>
            </div>
            <h1>è¡Œæç¢ºèª</h1>
        </div>
        <div class="header-btns">
            <span class="btn-text" onclick="showAddModal()">ï¼‹æ–°å¢é …ç›®</span>
            <span class="btn-text" onclick="toggleEditMode()" id="edit-toggle">ç·¨è¼¯æ¨¡å¼</span>
            <span class="btn-text" onclick="showSyncSheet()" style="color:var(--ios-red)">ğŸ”„ å¼·åˆ¶åŒæ­¥</span>
        </div>
    </div>

    <div id="settings-overlay" style="display:none; padding:20px; background:#e9e9eb; margin:10px 20px; border-radius:16px;">
        <input type="text" id="api-url-input" placeholder="è²¼ä¸Š URL...">
        <button class="btn-primary" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
    </div>

    <div id="list-container"></div>
    <div class="quick-nav" id="quick-nav"></div>

    <div id="item-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin:0 0 15px; font-size:22px;">ç·¨è¼¯é …ç›®</h3>
            <select id="f-category"></select>
            <input type="text" id="f-name" placeholder="åç¨±">
            <input type="text" id="f-note" placeholder="å‚™è¨»">
            <div style="display:flex; flex-direction:column; gap:10px; margin-top:20px;">
                <button class="btn-primary" onclick="saveItem()">å„²å­˜</button>
                <button class="btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="sync-overlay" class="modal" onclick="closeSyncSheet()" style="align-items:flex-end;">
        <div id="sync-sheet" onclick="event.stopPropagation()">
            <div class="sheet-container">
                <div class="sheet-btn" style="color:var(--ios-red); font-weight:600;" onclick="forceWrite()">è¦†è“‹é›²ç«¯ (å¼·åˆ¶å¯«å…¥)</div>
                <div class="sheet-btn" onclick="forceReload()">é‡æ–°æ•´ç† (é›²ç«¯ä¸‹è¼‰)</div>
            </div>
            <div class="sheet-cancel" onclick="closeSyncSheet()">å–æ¶ˆ</div>
        </div>
    </div>

    <script>
        let API_URL = localStorage.getItem('my_trip_api_url');
        let currentData = [];
        let isEditing = false;
        let editingOldName = null;
        let sortableInstances = [];
        let masterSortable = null;

        function setSyncStatus(status) {
            const led = document.getElementById('sync-led');
            const text = document.getElementById('sync-text');
            led.className = 'led';
            if (status === 'syncing') { led.classList.add('led-syncing'); text.innerText = 'æ­£åœ¨åŒæ­¥ä¸­...'; }
            else if (status === 'done') { led.classList.add('led-done'); text.innerText = `v1.5.0 å·²åŒæ­¥ (${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})})`; }
            else { led.classList.add('led-error'); text.innerText = 'åŒæ­¥å¤±æ•—'; }
        }

        async function fetchData() {
            if (!API_URL) return;
            setSyncStatus('syncing');
            try {
                const res = await fetch(API_URL);
                currentData = await res.json();
                renderList();
                setSyncStatus('done');
            } catch (e) { setSyncStatus('error'); }
        }

        function renderList() {
            const container = document.getElementById('list-container');
            const nav = document.getElementById('quick-nav');
            const select = document.getElementById('f-category');
            
            // æ¸…ç†èˆŠå¯¦ä¾‹
            if (masterSortable) masterSortable.destroy();
            sortableInstances.forEach(s => s.destroy());
            sortableInstances = [];
            
            container.innerHTML = ''; nav.innerHTML = ''; select.innerHTML = '<option value="+new">+ æ–°å¢ä¸»é …ç›®</option>';
            
            const groups = currentData.reduce((acc, i) => {
                const cat = i.category || 'æœªåˆ†é¡';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(i);
                return acc;
            }, {});

            // ä½¿ç”¨åŸæœ¬ currentData ä¸­çš„é¡åˆ¥å‡ºç¾é †åºä¾†æ’åˆ—
            const categoryOrder = [...new Set(currentData.map(i => i.category))];

            categoryOrder.forEach((cat, idx) => {
                const sectionId = `s-${idx}`;
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
                nav.innerHTML += `<a href="#${sectionId}" class="nav-item">${cat.substring(0,2)}</a>`;
                
                // å‰µå»ºé¡åˆ¥åŒ…è£å®¹å™¨ (æ”¯æ´ä¸»é …ç›®æ’åº)
                const catWrapper = document.createElement('div');
                catWrapper.className = 'category-wrapper';
                catWrapper.dataset.category = cat;
                
                catWrapper.innerHTML = `
                    <div class="section-header" id="${sectionId}">
                        <div class="section-left">
                            <span class="cat-drag-handle">â ¿</span>
                            <span class="section-title">${cat}</span>
                        </div>
                        <span class="btn-text edit-mode-only" onclick="editCategory('${cat}')" style="font-size:12px">é‡æ–°å‘½å</span>
                    </div>
                `;

                const groupDiv = document.createElement('div');
                groupDiv.className = 'list-group';
                groupDiv.dataset.category = cat;

                groups[cat].forEach(i => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'list-item';
                    itemDiv.dataset.name = i.name;
                    itemDiv.innerHTML = `
                        <span class="edit-mode-only" onclick="deleteItem('${i.name}')" style="color:var(--ios-red); margin-right:15px; font-size:20px; font-weight:bold;">âŠ–</span>
                        <div class="checkbox ${i.checked ? 'checked' : ''}" onclick="toggleCheck('${i.name}')"></div>
                        <div class="item-content" onclick="isEditing ? openEditModal('${i.name}') : toggleCheck('${i.name}')">
                            <div class="item-name">${i.name}</div>
                            <div class="item-note">${i.note || ''}</div>
                        </div>
                        <div class="drag-handle">â‰¡</div>
                    `;
                    groupDiv.appendChild(itemDiv);
                });
                catWrapper.appendChild(groupDiv);
                container.appendChild(catWrapper);

                // å­æ’åºï¼šé …ç›®æ‹–æ›³
                sortableInstances.push(Sortable.create(groupDiv, { 
                    group: 'trip-items', 
                    handle: '.drag-handle', 
                    animation: 150, 
                    scroll: true,
                    scrollSensitivity: 150, // ç¢°åˆ°é ‚éƒ¨å°è¦½åˆ—é‚Šç·£å³è§¸ç™¼å‘ä¸Šæ²å‹•
                    scrollSpeed: 20,
                    bubbleScroll: true,
                    onEnd: saveNewOrder 
                }));
            });

            // ä¸»æ’åºï¼šé¡åˆ¥æ‹–æ›³
            masterSortable = Sortable.create(container, {
                animation: 150,
                handle: '.cat-drag-handle', // å°ˆç”¨ä¸»é …ç›®æ‰‹æŠŠ
                scroll: true,
                scrollSensitivity: 150,
                scrollSpeed: 20,
                onEnd: saveNewOrder
            });
        }

        async function saveNewOrder() {
            const newList = [];
            // æŒ‰ç…§ç•¶å‰ DOM é †åºé‡æ–°æƒæ
            document.querySelectorAll('.category-wrapper').forEach(catWrap => {
                const categoryName = catWrap.dataset.category;
                catWrap.querySelectorAll('.list-item').forEach(el => {
                    const orig = currentData.find(i => i.name === el.dataset.name);
                    if (orig) newList.push({ ...orig, category: categoryName });
                });
            });
            currentData = newList;
            apiPost({ action: "sync_all", data: currentData });
        }

        // å…¶é¤˜é‚è¼¯ç¶­æŒ v1.4.3
        function openModal(id) { document.getElementById(id).classList.add('show'); }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('show')); }
        function showSyncSheet() { openModal('sync-overlay'); }
        function closeSyncSheet() { closeModal(); }
        function showAddModal() { editingOldName = null; document.getElementById('modal-title').innerText = "æ–°å¢é …ç›®"; document.getElementById('f-name').value = ""; document.getElementById('f-note').value = ""; openModal('item-modal'); }
        function openEditModal(name) { const item = currentData.find(i => i.name === name); editingOldName = name; document.getElementById('modal-title').innerText = "ç·¨è¼¯é …ç›®"; document.getElementById('f-category').value = item.category; document.getElementById('f-name').value = item.name; document.getElementById('f-note').value = item.note; openModal('item-modal'); }
        async function forceWrite() { closeSyncSheet(); setSyncStatus('syncing'); try { await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "sync_all", data: currentData }) }); setSyncStatus('done'); } catch (e) { setSyncStatus('error'); } }
        async function forceReload() { closeSyncSheet(); fetchData(); }
        async function apiPost(body) { setSyncStatus('syncing'); try { await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(body) }); setTimeout(() => setSyncStatus('done'), 1000); } catch (e) { setSyncStatus('error'); } }
        async function toggleCheck(name) { if (isEditing) return; const item = currentData.find(i => i.name === name); item.checked = !item.checked; renderList(); apiPost({ action: "update_checked", name, checked: item.checked }); }
        function toggleEditMode() { isEditing = !isEditing; document.getElementById('body').classList.toggle('is-editing', isEditing); document.getElementById('edit-toggle').innerText = isEditing ? 'å®Œæˆ' : 'ç·¨è¼¯æ¨¡å¼'; renderList(); }
        async function saveItem() {
            let cat = document.getElementById('f-category').value;
            const name = document.getElementById('f-name').value.trim();
            const note = document.getElementById('f-note').value.trim();
            if (cat === "+new") cat = prompt("ä¸»é …ç›®åç¨±?");
            if (!cat || !name) return;
            const action = editingOldName ? "edit_item" : "add_item";
            if (editingOldName) { const i = currentData.find(d => d.name === editingOldName); i.category = cat; i.name = name; i.note = note; }
            else { currentData.push({ category: cat, name, note, checked: false }); }
            renderList(); closeModal();
            apiPost({ action, category: cat, name, note, oldName: editingOldName, newName: name });
        }
        async function deleteItem(name) { if (confirm(`åˆªé™¤ã€Œ${name}ã€ï¼Ÿ`)) { currentData = currentData.filter(i => i.name !== name); renderList(); apiPost({ action: "delete_item", name }); } }
        async function editCategory(oldCat) { const newCat = prompt("é‡å‘½åé¡åˆ¥", oldCat); if (!newCat || newCat === oldCat) return; currentData.forEach(i => { if(i.category === oldCat) i.category = newCat; }); renderList(); apiPost({ action: "edit_category", oldCat, newCat }); }
        function toggleSettings() { const el = document.getElementById('settings-overlay'); el.style.display = el.style.display === 'block' ? 'none' : 'block'; }
        function saveSettings() { const url = document.getElementById('api-url-input').value.trim(); if (url) { localStorage.setItem('my_trip_api_url', url); API_URL = url; toggleSettings(); fetchData(); } }

        fetchData();
    </script>
</body>
</html>
