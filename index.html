<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>小 do 行李確認 v1.2.1</title>
    <style>
        :root { --ios-bg: #F2F2F7; --ios-card: #FFFFFF; --ios-blue: #007AFF; --ios-sep: #C6C6C8; --ios-red: #FF3B30; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--ios-bg); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 100px; }
        
        /* 標題列優化：容納三個按鈕 */
        .header { padding: 40px 20px 10px; display: flex; justify-content: space-between; align-items: flex-end; }
        .header h1 { margin: 0; font-size: 34px; line-height: 1.1; }
        .header-btns { display: flex; gap: 12px; margin-bottom: 4px; }
        .btn-text { color: var(--ios-blue); font-size: 16px; cursor: pointer; font-weight: 400; }
        
        /* 編輯模式標記 */
        .edit-mode-only { display: none; }
        .is-editing .edit-mode-only { display: inline-flex; }
        .is-editing .checkbox { display: none; }

        /* 列表樣式 */
        .section-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 20px 8px; }
        .section-title { font-size: 13px; color: #6e6e73; text-transform: uppercase; }
        .list-group { background: var(--ios-card); border-top: 0.5px solid var(--ios-sep); border-bottom: 0.5px solid var(--ios-sep); }
        .list-item { display: flex; align-items: center; padding: 12px 20px; border-bottom: 0.5px solid var(--ios-sep); }
        .item-content { flex: 1; }
        .item-name { font-size: 17px; }
        .item-note { font-size: 14px; color: #8e8e93; }
        
        /* 設定與表單彈窗 */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 24px; border-radius: 14px; width: 80%; max-width: 350px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        #settings-overlay { display: none; padding: 15px; background: #e9e9eb; margin: 10px 20px; border-radius: 10px; }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid var(--ios-sep); border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-main { background: var(--ios-blue); color: white; border: none; padding: 12px; border-radius: 10px; flex: 1; font-weight: 600; }
        .btn-cancel { background: #E5E5EA; color: black; border: none; padding: 12px; border-radius: 10px; flex: 1; }
        
        .checkbox { width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--ios-sep); margin-right: 15px; flex-shrink: 0; }
        .checkbox.checked { background-color: var(--ios-blue); border-color: var(--ios-blue); }
        .checkbox.checked::after { content: '✓'; color: white; display: block; text-align: center; line-height: 20px; }
        .delete-icon { color: var(--ios-red); margin-left: 10px; font-size: 18px; }
        
        /* 快速導覽 */
        .quick-nav { position: fixed; right: 6px; top: 55%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); padding: 12px 6px; border-radius: 20px; border: 0.5px solid var(--ios-sep); z-index: 999; }
        .nav-item { font-size: 10px; color: var(--ios-blue); text-decoration: none; text-align: center; font-weight: bold; }
    </style>
</head>
<body id="body">

    <div class="header">
        <div>
            <div style="font-size: 11px; color: #8e8e93; font-weight: 600;">v1.2.1</div>
            <h1>行李確認</h1>
        </div>
        <div class="header-btns">
            <span class="btn-text" onclick="toggleSettings()">設定</span>
            <span class="btn-text" onclick="showAddModal()">＋新增</span>
            <span class="btn-text" id="edit-toggle" onclick="toggleEditMode()">編輯</span>
        </div>
    </div>

    <div id="settings-overlay">
        <p style="margin-top:0; font-size:13px; color:#666;">API URL 設定</p>
        <input type="text" id="api-url-input" placeholder="貼上 Google Apps Script URL">
        <button class="btn-main" onclick="saveSettings()" style="padding:8px">儲存設定</button>
    </div>

    <div id="list-container"></div>
    <div class="quick-nav" id="quick-nav"></div>

    <div id="item-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0">新增項目</h3>
            <select id="f-category"></select>
            <input type="text" id="f-name" placeholder="項目名稱">
            <input type="text" id="f-note" placeholder="備註 (選填)">
            <div class="modal-btns">
                <button class="btn-cancel" onclick="closeModal()">取消</button>
                <button class="btn-main" id="modal-save-btn" onclick="saveItem()">儲存</button>
            </div>
        </div>
    </div>

    <script>
        let API_URL = localStorage.getItem('my_trip_api_url');
        let currentData = [];
        let isEditing = false;
        let editingOldName = null;

        async function fetchData() {
            if (!API_URL) {
                document.getElementById('list-container').innerHTML = `<div style="padding:50px; text-align:center; color:#999">請點擊上方「設定」輸入 API 網址</div>`;
                return;
            }
            try {
                const res = await fetch(API_URL);
                currentData = await res.json();
                renderList();
            } catch (e) { console.error('Fetch failed', e); }
        }

        function toggleSettings() {
            const el = document.getElementById('settings-overlay');
            el.style.display = el.style.display === 'block' ? 'none' : 'block';
            if (API_URL) document.getElementById('api-url-input').value = API_URL;
        }

        function saveSettings() {
            const url = document.getElementById('api-url-input').value.trim();
            if (url) {
                localStorage.setItem('my_trip_api_url', url);
                API_URL = url;
                toggleSettings();
                fetchData();
            }
        }

        function toggleEditMode() {
            isEditing = !isEditing;
            document.getElementById('body').classList.toggle('is-editing', isEditing);
            document.getElementById('edit-toggle').innerText = isEditing ? '完成' : '編輯';
            renderList();
        }

        function renderList() {
            const container = document.getElementById('list-container');
            const nav = document.getElementById('quick-nav');
            const select = document.getElementById('f-category');
            container.innerHTML = ''; nav.innerHTML = ''; 
            select.innerHTML = '<option value="+new">+ 新增主項目</option>';
            
            if (currentData.length === 0 && API_URL) {
                container.innerHTML = `<div style="padding:50px; text-align:center; color:#999">尚未有任何項目，點擊「新增」開始</div>`;
                return;
            }

            const groups = currentData.reduce((acc, i) => {
                if (!acc[i.category]) acc[i.category] = [];
                acc[i.category].push(i);
                return acc;
            }, {});

            Object.keys(groups).forEach((cat, idx) => {
                select.innerHTML += `<option value="${cat}">${cat}</option>`;
                nav.innerHTML += `<a href="#s-${idx}" class="nav-item">${cat.substring(0,2)}</a>`;

                let html = `<div class="section-header" id="s-${idx}">
                    <span class="section-title">${cat}</span>
                    <span class="btn-text edit-mode-only" onclick="editCategory('${cat}')" style="font-size:12px">重新命名</span>
                </div><div class="list-group">`;
                
                groups[cat].forEach(i => {
                    html += `
                    <div class="list-item">
                        <div class="checkbox ${i.checked ? 'checked' : ''}" onclick="toggleCheck('${i.name}')"></div>
                        <div class="item-content" onclick="${isEditing ? `openEditModal('${i.name}')` : `toggleCheck('${i.name}')`}">
                            <div class="item-name">${i.name}</div>
                            <div class="item-note">${i.note || ''}</div>
                        </div>
                        <span class="edit-mode-only delete-icon" onclick="deleteItem('${i.name}')">✕</span>
                    </div>`;
                });
                container.innerHTML += html + '</div>';
            });
        }

        function showAddModal() {
            editingOldName = null;
            document.getElementById('modal-title').innerText = "新增項目";
            document.getElementById('f-name').value = "";
            document.getElementById('f-note').value = "";
            document.getElementById('item-modal').style.display = 'flex';
        }

        function openEditModal(name) {
            const item = currentData.find(i => i.name === name);
            editingOldName = name;
            document.getElementById('modal-title').innerText = "編輯項目";
            document.getElementById('f-category').value = item.category;
            document.getElementById('f-name').value = item.name;
            document.getElementById('f-note').value = item.note;
            document.getElementById('item-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('item-modal').style.display = 'none'; }

        async function saveItem() {
            let cat = document.getElementById('f-category').value;
            const name = document.getElementById('f-name').value.trim();
            const note = document.getElementById('f-note').value.trim();
            
            if (cat === "+new") {
                cat = prompt("請輸入新主項目名稱 (例如：滑雪裝備)");
                if (!cat) return;
            }
            if (!name) return;

            const action = editingOldName ? "edit_item" : "add_item";
            const body = { action, category: cat, name, note, oldName: editingOldName, newName: name };

            if (editingOldName) {
                const i = currentData.find(d => d.name === editingOldName);
                i.category = cat; i.name = name; i.note = note;
            } else {
                currentData.push({ category: cat, name, note, checked: false });
            }
            renderList();
            closeModal();

            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(body) });
        }

        async function deleteItem(name) {
            if (!confirm(`確定要刪除「${name}」嗎？`)) return;
            currentData = currentData.filter(i => i.name !== name);
            renderList();
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "delete_item", name }) });
        }

        async function editCategory(oldCat) {
            const newCat = prompt("請輸入新的類別名稱", oldCat);
            if (!newCat || newCat === oldCat) return;
            currentData.forEach(i => { if(i.category === oldCat) i.category = newCat; });
            renderList();
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "edit_category", oldCat, newCat }) });
        }

        async function toggleCheck(name) {
            if (isEditing) return;
            const item = currentData.find(i => i.name === name);
            item.checked = !item.checked;
            renderList();
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: "update_checked", name, checked: item.checked }) });
        }

        fetchData();
    </script>
</body>
</html>
